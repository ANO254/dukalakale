{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-4 text-center">ðŸ›’ Your Shopping Cart</h2>

{% if cart_items %}
<div class="row g-4">
    <div class="col-lg-8">
        {% for item in cart_items %}
        <div class="card mb-3 shadow-sm border-0">
            <div class="row g-0 align-items-center">
                <div class="col-md-3 text-center p-3">
                    <img src="{{ item.image }}" class="img-fluid rounded" style="max-height:100px;" alt="{{ item.name }}">
                </div>

                <div class="col-md-6">
                    <div class="card-body">
                        <h5 class="fw-semibold mb-1">{{ item.name }}</h5>
                        <p class="text-muted mb-1">
                            Quantity:
                            <input type="number" value="{{ item.quantity }}" min="1" class="form-control quantity-input" data-product-id="{{ item.id }}">
                        </p>
                        <p class="text-muted mb-0">
                            Price: KES {{ item.price|floatformat:2 }}
                        </p>
                    </div>
                </div>

                <div class="col-md-3 text-center">
                    <div class="p-3">
                        <p class="fw-bold mb-2">
                            KES {{ item.price|floatformat:2 }}
                        </p>

                        <form method="POST" action="{% url 'remove_from_cart' item.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger mt-2">
                                Remove
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm border-0 sticky-top" style="top: 90px;">
            <div class="card-body">
                <h5 class="fw-bold mb-3">Order Summary</h5>

                <div class="d-flex justify-content-between mb-2">
                    <span>Total Items</span>
                    <span>{{ cart_items|length }}</span>
                </div>

                <div class="d-flex justify-content-between mb-3">
                    <span>Total</span>
                    <span class="fw-bold" id="cart-total">KES {{ total|floatformat:2 }}</span>
                </div>

                <button class="btn btn-dark w-100">
                    Proceed to Checkout â†’
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('change', function() {
        const productId = this.dataset.productId;
        const quantity = this.value;

        fetch(`/cart/update-quantity/${productId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `quantity=${quantity}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('cart-total').innerText = data.total;
            }
        });
    });
});
</script>

{% else %}
<div class="text-center py-5">
    <h4 class="fw-semibold">Your cart is empty</h4>
    <p class="text-muted mb-4">Looks like you havenâ€™t added anything yet.</p>
    <a href="/shop/" class="btn btn-dark">Continue Shopping</a>
</div>
{% endif %}

{% endblock %}
